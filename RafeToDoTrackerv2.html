<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Rafe’s Quest Board</title>
<style>
  :root{
    --accent:#22c55e; --accent2:#3b82f6;

    /* Defaults; overridden by data-theme */
    --bg:#0f172a; --text:#e5e7eb; --muted:#94a3b8;
    --card:#0f1626; --card-border:#1f2937; --card-shadow: 0 12px 40px rgba(0,0,0,.45);
    --surface:#0b1222;
    --ringTrack:#1f2937; --ringGrad1:#22c55e; --ringGrad2:#3b82f6;
  }

  /* Daylight theme */
  html[data-theme="day"]{
    --bg:#f5f7fb;
    --text:#0b1222;
    --muted:#475569;
    --card:#ffffff;
    --card-border:#d6e0ea;
    --card-shadow: 0 10px 24px rgba(15,23,42,.08);
    --surface:#f0f4fa;
    --ringTrack:#e2e8f0;
  }

  /* Nightfall theme */
  html[data-theme="night"]{
    --bg:#0f172a;
    --text:#e5e7eb;
    --muted:#94a3b8;
    --card:#0f1626;
    --card-border:#1f2937;
    --card-shadow: 0 12px 40px rgba(0,0,0,.45);
    --surface:#0b1222;
    --ringTrack:#1f2937;
  }

  html,body{
    margin:0; padding:0;
    background:var(--bg); color:var(--text);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
    transition: background-color .35s ease, color .25s ease;
    height:100%; min-height:100%;
    overflow-x:hidden; overscroll-behavior-y:none;
  }

  .wrap{max-width:960px;margin:0 auto;padding:16px;position:relative;min-height:100svh}
  .grid{display:grid;grid-template-columns:1fr;gap:12px;margin-top:12px}
  @media(min-width:700px){ .grid{grid-template-columns:1fr 1fr} }

  /* Cards */
  .card{
    background: linear-gradient(180deg, var(--card) 0%, color-mix(in oklab, var(--card), #000 6%) 100%);
    border:1px solid var(--card-border);
    border-radius:16px;padding:14px;
    box-shadow: var(--card-shadow), inset 0 1px 0 color-mix(in oklab, #fff, transparent 92%);
    position:relative; overflow:hidden;
  }
  .card::after{
    content:""; position:absolute; inset:-1px; pointer-events:none;
    background: radial-gradient(1000px 120px at 20% -40px, color-mix(in oklab, #fff, transparent 94%), transparent 60%);
  }

  .topbar{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
  .brand{display:flex;align-items:center;gap:12px;min-width:0}
  .crest{ width:44px; height:44px; position:relative; flex:0 0 auto; display:grid; place-items:center; }
  .crest svg{ width:44px; height:44px; display:block }
  .crest .lvl{ position:absolute; font-weight:900; font-size:12px; letter-spacing:.3px; color:#bbf7d0; text-shadow:0 1px 1px rgba(0,0,0,.45); padding:0 0; border-radius:6px; }
  /* Daylight readability improvement */
  html[data-theme="day"] .crest .lvl{
    color:#0b1222;
    background: rgba(255,255,255,.9);
    padding:2px 6px;
    text-shadow: none;
    box-shadow: 0 1px 0 rgba(0,0,0,.06);
  }

  .brand-text{display:flex;flex-direction:column;min-width:0}
  .title{font-size:18px;font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .subtitle{font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .actions{display:flex;gap:8px;flex-wrap:wrap}

  .row{
    display:flex;align-items:center;justify-content:space-between;gap:10px;
    padding:10px 12px;margin:6px 0;border-radius:12px;
    background:var(--surface);border:1px solid var(--card-border);
    transition: transform .12s ease, background .2s ease, border-color .2s ease;
  }
  .row:hover{ transform: translateY(-1px); }
  .row.done{
    background: color-mix(in oklab, #22c55e 22%, var(--surface));
    border-color: color-mix(in oklab, #22c55e 40%, var(--card-border));
  }
  .left{display:flex;align-items:center;gap:10px;min-width:0}
  .icon{
    width:26px;height:26px;display:grid;place-items:center;border-radius:8px;background:color-mix(in oklab, var(--surface), #000 0%);border:1px solid #243042;flex:0 0 auto; position:relative;
  }
  .icon::after{content:""; position:absolute; inset:-2px; border-radius:8px; box-shadow:0 0 18px rgba(59,130,246,.45); opacity:.18;}
  html[data-theme="day"] .icon::after{ opacity:.22; box-shadow:0 0 18px rgba(59,130,246,.35); }
  .row.done .icon{ border-color: rgba(34,197,94,.6); box-shadow: 0 0 0 2px rgba(34,197,94,.12); }
  .label{font-weight:600}
  .sub{font-size:12px;color:var(--muted)}
  .xp{font-variant-numeric:tabular-nums;color:#16a34a;white-space:nowrap;flex:0 0 auto}

  .chip,button{
    background:var(--surface);color:var(--text);border:1px solid var(--card-border);border-radius:10px;padding:10px 12px;cursor:pointer;box-shadow:var(--card-shadow);
    transition:transform .05s ease, background .2s ease, border-color .2s ease
  }
  button:active{transform:scale(.98)}
  .chip{font-size:14px}
  .chip.small{padding:6px 10px;font-size:12px}
  .active{border-color:var(--accent2);box-shadow:0 0 0 2px color-mix(in oklab, var(--accent2) 35%, transparent), var(--card-shadow)}

  .section-title{font-size:14px;color:#a5b4fc;margin:6px 0 2px 2px;letter-spacing:.4px}
  .footer{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin-top:10px}

  .progress{height:10px;background:color-mix(in oklab, var(--surface), #000 0%);border:1px solid var(--card-border);border-radius:999px;overflow:hidden;min-width:120px; position:relative}
  .progress>div{
    height:100%;background:linear-gradient(90deg,var(--accent2),var(--accent));
    width:0%; transition:width .6s cubic-bezier(.22,.61,.36,1); position:relative;
  }
  .progress>div::after{
    content:""; position:absolute; inset:0; pointer-events:none;
    background:linear-gradient(120deg,transparent 0%, rgba(255,255,255,.25) 40%, transparent 80%);
    transform:translateX(-100%); animation:shine 2.8s linear infinite;
  }
  @keyframes shine{ to{ transform:translateX(100%); } }

  #xp.pulse{ animation: xpPulse .35s ease; display:inline-block }
  @keyframes xpPulse{ 0%{transform:scale(1); color:#16a34a} 50%{transform:scale(1.12); color:#22c55e} 100%{transform:scale(1); color:#16a34a} }

  .pill{padding:4px 8px;border-radius:999px;background:color-mix(in oklab, var(--surface), #000 0%);border:1px solid var(--card-border);font-variant-numeric:tabular-nums;white-space:nowrap}

  /* Rewards gallery */
  .rewards{display:flex;flex-wrap:wrap;gap:8px}
  .reward{
    display:inline-flex;gap:8px;align-items:center;margin:4px 0;padding:6px 10px;border-radius:999px;border:1px solid var(--card-border);
    background: linear-gradient(180deg, color-mix(in oklab, var(--surface), #000 0%), color-mix(in oklab, var(--surface), #000 6%));
    cursor: default; user-select:none;
  }
  html[data-theme="day"] .reward{ background:linear-gradient(180deg,#f9fbff,#f1f5ff); }
  .reward.available{ border-color: #22c55e; box-shadow: 0 0 0 2px rgba(34,197,94,.18), inset 0 0 0 1px rgba(34,197,94,.35); cursor: pointer; }
  .reward.locked{ opacity:.55 }
  .reward .reason{ font-size:11px; color:var(--muted); }

  .recent-reward{ font-size:12px; color:#a5b4fc; }

  @media print{
    body{background:#fff;color:#000}
    .wrap{max-width:100%;padding:0}
    .card::after, .crest svg, .crest .lvl, .nav{display:none !important}
    .card, .row, button, .chip{box-shadow:none}
    .row, .chip, .pill{border-color:#000}
  }

  /* Dialogs */
  dialog{border:none;border-radius:12px;padding:0;background:var(--card);color:var(--text);box-shadow:var(--card-shadow);width:min(960px,96vw)}
  dialog::backdrop{background:rgba(0,0,0,.5)}
  .dlg-head{padding:12px 14px;border-bottom:1px solid var(--card-border);display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap}
  .dlg-title{font-weight:700}
  .dlg-body{padding:12px 14px;max-height:72vh;overflow:auto}
  .form-grid{display:grid;grid-template-columns:1fr;gap:10px}
  @media(min-width:920px){ .form-grid{grid-template-columns:minmax(0,1fr) minmax(0,1fr); align-items:start; } }
  label{display:block;font-size:12px;color:var(--muted);margin-bottom:4px}
  input[type="text"],input[type="number"],textarea,input[type="time"]{width:100%;padding:8px 10px;border-radius:10px;border:1px solid var(--card-border);background:var(--surface);color:var(--text);min-width:0}
  fieldset{border:1px solid var(--card-border);border-radius:10px;padding:10px}
  legend{padding:0 6px;color:#a5b4fc}
  .dlg-actions{display:flex;gap:8px;justify-content:flex-end;padding:10px 14px;border-top:1px solid var(--card-border)}
  .note{font-size:12px;color:var(--muted)}

  .task-card{border:1px solid var(--card-border);border-radius:10px;padding:10px;background:var(--surface)}
  .task-row{display:grid;grid-template-columns:minmax(0,120px) minmax(220px,1fr) minmax(0,100px) minmax(0,240px);gap:8px}
  @media(max-width:920px){ .task-row{grid-template-columns:1fr 1fr} }
  .task-actions{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
  .inline{display:flex;gap:8px;align-items:center;flex-wrap:wrap;min-width:0}
  .small-note{font-size:11px;color:var(--muted)}
  .days-wrap{display:flex;gap:6px;flex-wrap:wrap;margin:6px 0 0 0}
  .days-wrap .chip{padding:6px 10px;font-size:12px}
  .days-wrap .chip.active{ background:linear-gradient(180deg,#0d1b2a,#0b1222); border-color:#3b82f6; box-shadow: 0 0 0 2px rgba(59,130,246,.2); }
  html[data-theme="day"] .days-wrap .chip.active{ background:linear-gradient(180deg,#e6f0ff,#f0f6ff); }

  /* Reward picker modal */
  #rewardPicker .grid{
    display:grid; grid-template-columns:1fr; gap:10px;
  }
  @media(min-width:650px){ #rewardPicker .grid{ grid-template-columns:1fr 1fr; } }
  .reward-card{
    border:1px solid var(--card-border); border-radius:12px; padding:10px; background:var(--surface);
    display:flex; justify-content:space-between; align-items:center; gap:8px;
  }
  .reward-card .meta{ font-size:12px; color:var(--muted); }
  .reward-card.locked{ opacity:.6 }
  .reward-card .pick{ white-space:nowrap }

  /* Lock body scroll when modal open (mobile fix) */
  body.modal-open{ overflow:hidden; position:relative; height:100%; }
</style>
</head>
<body>
<div class="wrap">
  <div id="app">
    <div class="topbar nav">
      <div class="brand">
        <!-- Level crest -->
        <div class="crest" aria-hidden="true">
          <svg viewBox="0 0 44 44">
            <defs>
              <linearGradient id="ringGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" stop-color="var(--ringGrad2)"/>
                <stop offset="100%" stop-color="var(--ringGrad1)"/>
              </linearGradient>
            </defs>
            <circle cx="22" cy="22" r="18" fill="var(--surface)" stroke="var(--ringTrack)" stroke-width="4"></circle>
            <circle id="lvl-ring" cx="22" cy="22" r="18" fill="none" stroke="url(#ringGrad)" stroke-width="4"
              stroke-linecap="round" stroke-dasharray="113.097" stroke-dashoffset="113.097"
              transform="rotate(-90 22 22)"></circle>
          </svg>
          <div class="lvl" id="crest-level">0</div>
        </div>
        <div class="brand-text">
          <div class="title">Rafe’s Quest Board</div>
          <div class="subtitle">Earn XP. Hit goals. Pick rewards.</div>
        </div>
      </div>
      <div class="actions">
        <button id="reset-week" class="chip" title="Resets weekly counters">New Week</button>
        <button id="print-checklist" class="chip">Print Checklist (A4)</button>
        <button id="print-ledger" class="chip">Print Ledger (A4)</button>
        <button id="parent-mode" class="chip" title="Edit settings (PIN)">Parent Mode</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="section-title">Today’s Tasks <span id="date-span" class="sub"></span></div>
        <div id="task-list" aria-live="polite"></div>

        <div class="footer">
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <div class="sub">On-Time Bonus (ready by 8:30):</div>
            <button id="toggle-ontime" class="chip">+10 XP</button>
            <button id="reset-today" class="chip" title="Clear today’s checkmarks">Reset Today</button>
          </div>
          <div class="progress" title="Level progress">
            <div id="level-progress"></div>
          </div>
          <div class="sub">Level <span id="level">0</span> · <span id="xp">0</span> XP · Week <span id="week-xp">0</span> XP
            <span id="recent-reward" class="recent-reward"></span>
            <button id="choose-reward" class="chip" style="display:none">Choose reward</button>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="section-title">Weekly Goals</div>
        <div id="weekly-goals"></div>

        <div class="section-title">Level-Up Rewards</div>
        <div class="rewards" id="rewards"></div>
      </div>
    </div>
  </div>
</div>

<canvas id="confetti" class="confetti-layer" aria-hidden="true" style="position:fixed; inset:0; pointer-events:none;"></canvas>

<!-- Parent Settings -->
<dialog id="settingsDlg">
  <div class="dlg-head">
    <div class="dlg-title">Parent Settings</div>
    <div>
      <button class="chip" id="cfg-export">Export</button>
      <button class="chip" id="cfg-import">Import</button>
      <button class="chip" id="cfg-reset">Reset</button>
      <button class="chip" id="cfg-close">Close</button>
    </div>
  </div>
  <div class="dlg-body">
    <div class="form-grid">
      <div>
        <fieldset>
          <legend>XP & Level</legend>
          <label>Level step (XP per level)
            <input id="cfg-levelStep" type="number" min="1" step="1">
          </label>
          <label>On-time bonus XP
            <input id="cfg-onTimeXp" type="number" min="0" step="1">
          </label>
        </fieldset>

        <fieldset id="tasks-fieldset" data-span="full">
          <legend>Tasks</legend>
          <div class="note" style="margin-bottom:8px">
            Each task shows on the weekdays you select below. “On-time bonus” is special and cannot be removed or have its ID changed.
          </div>
          <div id="tasks-manager" style="display:flex;flex-direction:column;gap:10px"></div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
            <button class="chip" type="button" id="task-add">Add Task</button>
          </div>
        </fieldset>

        <fieldset id="rewards-fieldset" data-span="full">
          <legend>Rewards</legend>
          <div id="rewards-manager" style="display:flex;flex-direction:column;gap:8px"></div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
            <button class="chip" type="button" id="reward-add">Add Reward</button>
          </div>
          <p class="note">Weekly lockout prevents picking the same reward more than once per week. Level cooldown makes a reward available again only after gaining N more levels.</p>
        </fieldset>

        <fieldset>
          <legend>Theme</legend>
          <div class="inline" style="gap:10px;flex-wrap:wrap">
            <label class="inline" style="gap:6px">
              <input type="radio" name="cfg-theme-mode" value="auto"> Auto (day/night by time)
            </label>
            <label class="inline" style="gap:6px">
              <input type="radio" name="cfg-theme-mode" value="day"> Daylight
            </label>
            <label class="inline" style="gap:6px">
              <input type="radio" name="cfg-theme-mode" value="night"> Nightfall
            </label>
          </div>
          <div class="inline" style="gap:10px; margin-top:6px">
            <label>Daylight starts</label>
            <input id="cfg-day-start" type="time" value="07:00" style="width:130px">
            <label>Nightfall starts</label>
            <input id="cfg-night-start" type="time" value="19:00" style="width:130px">
          </div>
          <p class="note">Auto uses your local time.</p>
        </fieldset>

        <fieldset>
          <legend>Level-up celebration</legend>
          <label class="inline" style="gap:6px">
            <input type="checkbox" id="cfg-confetti">
            Confetti on level-up
          </label>
          <label class="inline" style="gap:6px">
            <input type="checkbox" id="cfg-sound">
            Sound on level-up
          </label>
        </fieldset>

        <fieldset>
          <legend>Parent PIN</legend>
          <label>New Parent PIN
            <input id="cfg-newPin" type="text" inputmode="numeric" placeholder="Leave blank to keep current">
          </label>
          <label>Recovery hint (optional)
            <input id="cfg-pinHint" type="text" placeholder="E.g., Last 4 of grandma’s phone">
          </label>
        </fieldset>

        <fieldset>
          <legend>Manual XP Adjustment</legend>
          <div class="inline" style="gap:10px; align-items:flex-end">
            <div style="min-width:160px">
              <label>Adjust XP (±)</label>
              <input id="cfg-xp-delta" type="number" step="1" placeholder="e.g., 25 or -10">
            </div>
            <button class="chip" type="button" id="cfg-apply-delta">Apply to total & week XP</button>
            <button class="chip" type="button" id="cfg-undo-delta">Undo last adjustment</button>
          </div>
          <div class="inline" style="gap:10px; margin-top:8px; align-items:flex-end">
            <div style="min-width:160px">
              <label>Set exact level (optional)</label>
              <input id="cfg-set-level" type="number" min="0" step="1" placeholder="e.g., 3">
            </div>
            <button class="chip" type="button" id="cfg-apply-level">Set Level</button>
          </div>
        </fieldset>
      </div>
    </div>
  </div>
  <div class="dlg-actions">
    <button class="chip" id="cfg-save">Save</button>
  </div>
</dialog>

<!-- Reward picker dialog -->
<dialog id="rewardPicker">
  <div class="dlg-head">
    <div class="dlg-title">Choose a reward</div>
    <button class="chip" type="button" id="rp-close">Close</button>
  </div>
  <div class="dlg-body">
    <div id="rp-info" class="note" style="margin-bottom:8px"></div>
    <div class="grid" id="rp-grid"></div>
  </div>
</dialog>

<script>
(function(){
  if (typeof window.structuredClone !== "function") {
    window.structuredClone = obj => JSON.parse(JSON.stringify(obj));
  }

  const CHILD_ID = "rafe";
  const DEFAULT_PIN = "7497";
  const ALL_DAYS = [1,2,3,4,5,6,7];

  // Defaults and config
  const DEFAULTS = {
    LEVEL_STEP: 120,
    onTimeXp: 10,
    celebrate: { confetti: true, sound: false },
    parentPin: DEFAULT_PIN,
    pinHint: "",
    theme: { mode: "auto", dayStart: "07:00", nightStart: "19:00" },
    tasks: [
      { id:"workout", icon:"🏊‍♂️", label:"Swimmer Workout", xp:10, days:[1,2,3,4,5],
        weekly:{ key:"workout", goal:3, bonusAt:4, bonusXp:10 } },
      { id:"homework1", icon:"✏️", label:"Homework Block 1 (25 min)", xp:8, days:[1,2,3,4,5] },
      { id:"homework2", icon:"⏱️", label:"Homework Block 2 (optional)", xp:4, days:[1,2,3,4,5] },
      { id:"music", icon:"🎵", label:"Music practice (15 min)", xp:8, days:[1,2,3,4,5],
        weekly:{ key:"music", goal:4, bonusAt:5, bonusXp:10 } },
      { id:"spanish", icon:"💬", label:"Spanish — complete a lesson", xp:10, days:[1,2,3,4,5],
        weekly:{ key:"spanish", goal:3, bonusAt:4, bonusXp:10 } },
      { id:"lunch", icon:"🥪", label:"Pack lunch + water", xp:8, days:[1,2,3,4,5],
        weekly:{ key:"lunch", goal:5 } },
      { id:"backpack", icon:"🎒", label:"Backpack reset", xp:4, days:[1,2,3,4,5,6,7] },
      { id:"swim", icon:"🏊", label:"Pack swim bag", xp:8, days:[4,5,7],
        weekly:{ key:"swim", goalFrom:"swimRequired" } },
      { id:"dishes", icon:"🍽️", label:"Wash and put away dishes", xp:10, days:[1,2,3,4,5,6,7] },
      { id:"hygiene", icon:"🛁", label:"Shower + teeth", xp:4, days:[1,2,3,4,5,6,7] },
      { id:"clothes", icon:"👕", label:"Clothes out for tomorrow", xp:4, days:[1,2,3,4,5,6,7] },
      { id:"ontime", icon:"⭐", label:"On-time bonus", xp:10, special:"ontime" }
    ],
    rewards: [
      { id:"movie", label:"🎬 Movie night", minLevel:1, weeklyLockout:false, levelCooldown:0 },
      { id:"pizza", label:"🍕 Pizza night", minLevel:1, weeklyLockout:false, levelCooldown:0 },
      { id:"boardgame", label:"🎲 Board game with Dad", minLevel:1, weeklyLockout:false, levelCooldown:0 },
      { id:"screen30", label:"📱 30 min screen time", minLevel:1, weeklyLockout:true, levelCooldown:0 },
      { id:"savings50", label:"💵 $50 toward savings", minLevel:3, weeklyLockout:false, levelCooldown:5 }
    ]
  };

  const isoDow = d => { let n = d.getDay(); return n===0?7:n; };
  const pad = n => String(n).padStart(2,'0');
  const fmtDate = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  const now = () => new Date();
  const clamp = (v,min,max)=>Math.min(max,Math.max(min,v));

  const CFG_KEY = `xp-config-nostar-${CHILD_ID}`;
  function deepMerge(base, over){
    if (Array.isArray(base)) return Array.isArray(over) ? over.slice() : base.slice();
    if (base && typeof base==="object" && over && typeof over==="object"){
      const out = {...base};
      for (const k of Object.keys(over)) out[k] = k in base ? deepMerge(base[k], over[k]) : structuredClone(over[k]);
      return out;
    }
    return over ?? base;
  }
  function loadCfg(){ try{ return JSON.parse(localStorage.getItem(CFG_KEY)||"null")||{}; }catch{ return {}; } }
  function saveCfg(){ localStorage.setItem(CFG_KEY, JSON.stringify(CONFIG)); }

  // Load config and migrate
  let CONFIG = deepMerge(DEFAULTS, loadCfg());
  migrateTasksDays(CONFIG);
  migrateRewards(CONFIG);
  saveCfg();

  const getLevelStep = () => Math.max(1, Number(CONFIG.LEVEL_STEP||DEFAULTS.LEVEL_STEP));
  const getOnTimeXp = () => Math.max(0, Number(CONFIG.onTimeXp ?? DEFAULTS.onTimeXp));
  const getTasks = () => CONFIG.tasks;
  const getRewards = () => CONFIG.rewards;

  // State
  const KEY = `xp-tracker-nostar-${CHILD_ID}`;
  let state = null;
  try { state = JSON.parse(localStorage.getItem(KEY) || "null"); } catch(e){ state = null; }
  if(!state){
    state = { weekStart: getWeekStart(now()), _alertLock:false, adjustments:[], child: initChild(), rewardsLog:[], rewardLocks:{} };
    save();
  } else {
    if(!state.child) state.child = initChild();
    if(!state.weekStart) state.weekStart = getWeekStart(now());
    if(typeof state._alertLock!=="boolean") state._alertLock=false;
    if(!Array.isArray(state.adjustments)) state.adjustments=[];
    if(!Array.isArray(state.rewardsLog)) state.rewardsLog=[];
    if(!state.rewardLocks || typeof state.rewardLocks!=="object") state.rewardLocks = {};
  }

  function initChild(){
    return {
      xp: 0, level: 0, weekXp: 0,
      unclaimedLevels: 0,
      weekly: { counts: { music:0, spanish:0, lunch:0, swim:0, workout:0 }, flags: { music:false, spanish:false, workout:false }, swimRequired: 0 },
      today: {}, lastDate: null
    };
  }

  function getWeekStart(d){
    const dt = new Date(d);
    const day = isoDow(dt);
    dt.setDate(dt.getDate() - (day-1));
    dt.setHours(0,0,0,0);
    return fmtDate(dt);
  }

  function save(){ try{ localStorage.setItem(KEY, JSON.stringify(state)); }catch(e){} }

  const $ = s => document.querySelector(s);
  const dateSpan = $("#date-span");
  const taskList = $("#task-list");
  const weeklyGoalsWrap = $("#weekly-goals");
  const rewardsWrap = $("#rewards");
  const crestLevel = document.getElementById("crest-level");
  const crestRing = document.getElementById("lvl-ring");
  const levelSpan = document.getElementById("level");
  const xpSpan = document.getElementById("xp");
  const weekXpSpan = document.getElementById("week-xp");
  const levelProgress = document.getElementById("level-progress");
  const recentRewardSpan = document.getElementById("recent-reward");
  const chooseRewardBtn = document.getElementById("choose-reward");

  // THEME: auto day/night
  function toMins(hhmm){
    const m = String(hhmm||"").match(/^(\d{1,2}):(\d{2})$/);
    if(!m) return 7*60;
    const h = Math.max(0, Math.min(23, parseInt(m[1],10)));
    const mi = Math.max(0, Math.min(59, parseInt(m[2],10)));
    return h*60 + mi;
  }
  function applyTheme(){
    const t = CONFIG.theme || DEFAULTS.theme;
    let mode = (t.mode || "auto");
    if(mode === "auto"){
      const mins = new Date().getHours()*60 + new Date().getMinutes();
      const dayMins = toMins(t.dayStart||"07:00");
      const nightMins = toMins(t.nightStart||"19:00");
      const isDay = dayMins < nightMins
        ? (mins >= dayMins && mins < nightMins)
        : !(mins >= nightMins && mins < dayMins);
      document.documentElement.setAttribute("data-theme", isDay ? "day" : "night");
    } else {
      document.documentElement.setAttribute("data-theme", mode==="day" ? "day" : "night");
    }
  }
  applyTheme();
  setInterval(applyTheme, 10*60*1000);

  // Top actions
  $("#reset-week").addEventListener("click", ()=>{
    const pin = prompt("Enter parent PIN to start a new week:");
    if(pin !== (CONFIG.parentPin||DEFAULTS.parentPin)){ alert(pinWrongMsg()); return; }
    doNewWeekReset(true);
  });

  $("#toggle-ontime").addEventListener("click", ()=>{
    const pin = prompt("Enter parent PIN to toggle On-Time bonus:");
    if(pin !== (CONFIG.parentPin||DEFAULTS.parentPin)){ alert(pinWrongMsg()); return; }
    const t = getTasks().find(x=>x.id==="ontime");
    if(!t) return;
    toggleTask(t);
  });

  $("#reset-today").addEventListener("click", ()=>{
    if(!confirm("Reset today? This will clear today’s checkmarks and adjust XP and weekly goals accordingly.")) return;
    resetToday();
  });

  $("#parent-mode").addEventListener("click", ()=>{
    const pin = prompt("Enter Parent PIN:");
    if(pin !== (CONFIG.parentPin||DEFAULTS.parentPin)){ alert(pinWrongMsg()); return; }
    openSettings();
  });

  chooseRewardBtn.addEventListener("click", ()=>{
    openRewardPicker();
  });

  setInterval(()=>{ autoWeekRollover(); }, 60*1000);
  function autoWeekRollover(){
    const start = new Date(state.weekStart);
    const nextStart = new Date(start); nextStart.setDate(start.getDate()+7);
    if(now() >= nextStart){ doNewWeekReset(false); }
  }

  function doNewWeekReset(showAlert){
    state.child.weekly = { counts: { music:0, spanish:0, lunch:0, swim:0, workout:0 }, flags: { music:false, spanish:false, workout:false }, swimRequired: 0 };
    state.child.weekXp = 0;
    state.child.today = {};
    state.child.lastDate = null;

    const newWeekStart = getWeekStart(now());
    state.weekStart = newWeekStart;

    for(const rid in state.rewardLocks){
      const lock = state.rewardLocks[rid];
      if(lock && lock.untilWeekStart && lock.untilWeekStart !== newWeekStart){
        delete lock.untilWeekStart;
      }
      if(lock && Object.keys(lock).length===0) delete state.rewardLocks[rid];
    }

    save(); render();
    if(showAlert) alert("New week started. Weekly counters reset.");
  }

  function tasksForTonight(){
    const dow = isoDow(now());
    return getTasks().filter(t => {
      if(t.special === "ontime") return false;
      const days = Array.isArray(t.days) ? t.days : ALL_DAYS;
      return days.includes(dow);
    });
  }

  function ensureToday(){
    const d = now();
    const dateStr = fmtDate(d);
    const child = state.child;
    if(child.lastDate !== dateStr){
      child.today = {};
      child.lastDate = dateStr;
      save();
    }
  }

  function applyXp(delta){
    const ch = state.child;
    ch.xp = Math.max(0, (ch.xp||0) + delta);
    ch.weekXp = Math.max(0, (ch.weekXp||0) + delta);
    xpSpan.classList.remove("pulse");
    void xpSpan.offsetWidth;
    xpSpan.classList.add("pulse");
    const leveled = levelCheck();
    if(leveled > 0){
      ch.unclaimedLevels += leveled;
      save();
      render();
      openRewardPicker();
    }
  }

  function pinWrongMsg(){
    const hint = CONFIG.pinHint ? `\nHint: ${CONFIG.pinHint}` : "";
    return `Incorrect PIN.${hint}`;
  }

  function levelCheck(){
    const ch = state.child;
    const step = getLevelStep();
    let leveled = 0;
    if(state._alertLock) return 0;
    while(ch.xp >= ch.level * step + step){
      ch.level += 1;
      leveled += 1;
      celebrateLevelUp(ch.level);
      state._alertLock = true;
      setTimeout(()=>{ state._alertLock = false; }, 300);
    }
    return leveled;
  }

  function celebrateLevelUp(){
    if (CONFIG.celebrate?.confetti) runConfetti(900);
    if (CONFIG.celebrate?.sound) playChime();
  }

  // Confetti
  const confettiCanvas = document.getElementById("confetti");
  let confettiCtx = confettiCanvas.getContext("2d");
  function resizeConfetti(){ confettiCanvas.width = window.innerWidth; confettiCanvas.height = window.innerHeight; }
  window.addEventListener("resize", resizeConfetti, {passive:true});
  resizeConfetti();

  function runConfetti(duration=800){
    const colors = ["#22c55e","#3b82f6","#f59e0b","#ef4444","#a78bfa","#06b6d4"];
    const count = Math.min(160, Math.floor((confettiCanvas.width*confettiCanvas.height)/25000));
    const parts = Array.from({length: count}, ()=>({
      x: Math.random()*confettiCanvas.width,
      y: -10 - Math.random()*40,
      s: 4 + Math.random()*6,
      r: Math.random()*Math.PI,
      v: 2 + Math.random()*3,
      vr: (Math.random()-0.5)*0.3,
      c: colors[(Math.random()*colors.length)|0]
    }));
    let start = performance.now();
    function tick(t){
      const elapsed = t - start;
      confettiCtx.clearRect(0,0,confettiCanvas.width,confettiCanvas.height);
      parts.forEach(p=>{
        p.y += p.v; p.r += p.vr;
        confettiCtx.save(); confettiCtx.translate(p.x, p.y); confettiCtx.rotate(p.r);
        confettiCtx.fillStyle = p.c; confettiCtx.fillRect(-p.s/2, -p.s/2, p.s, p.s);
        confettiCtx.restore();
      });
      if (elapsed < duration) requestAnimationFrame(tick);
      else confettiCtx.clearRect(0,0,confettiCanvas.width,confettiCanvas.height);
    }
    requestAnimationFrame(tick);
  }

  // Audio
  let audioCtx = null;
  function playChime(){
    try{
      if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
      const t0 = audioCtx.currentTime;
      const o1 = audioCtx.createOscillator();
      const g1 = audioCtx.createGain();
      o1.type = "triangle";
      o1.frequency.setValueAtTime(880, t0);
      o1.frequency.exponentialRampToValueAtTime(1320, t0+0.18);
      g1.gain.setValueAtTime(0.001, t0);
      g1.gain.exponentialRampToValueAtTime(0.2, t0+0.02);
      g1.gain.exponentialRampToValueAtTime(0.0001, t0+0.5);
      o1.connect(g1).connect(audioCtx.destination);
      o1.start(t0); o1.stop(t0+0.5);
    }catch(e){}
  }

  function requiredSwimPacksThisWeek(){
    const t = getTasks().find(x=>x.id==="swim");
    const days = Array.isArray(t?.days) ? t.days.length : 0;
    return days;
  }

  function updateWeekly(task, nowDone){
    const w = state.child.weekly;
    if(!task.weekly) return;
    const key = task.weekly.key;
    const before = w.counts[key] || 0;
    const after = clamp(before + (nowDone?1:-1), 0, 99);
    w.counts[key] = after;

    if(task.weekly.goalFrom === "swimRequired"){
      w.swimRequired = requiredSwimPacksThisWeek();
    }

    if(typeof task.weekly.bonusAt === "number" && typeof task.weekly.bonusXp === "number"){
      const flag = !!w.flags[key];
      if(nowDone && after === task.weekly.bonusAt && !flag){
        w.flags[key] = true;
        applyXp(task.weekly.bonusXp);
      } else if(!nowDone && before === task.weekly.bonusAt && after === task.weekly.bonusAt-1 && flag){
        w.flags[key] = false;
        applyXp(-task.weekly.bonusXp);
      }
    }
  }

  function toggleTask(task){
    const ch = state.child;
    const id = task.id;
    const nowDone = !ch.today[id];
    ch.today[id] = nowDone;

    const delta = task.xp ? (nowDone ? task.xp : -task.xp) : 0;
    if(delta) applyXp(delta);
    updateWeekly(task, nowDone);
    save(); render();
  }

  function resetToday(){
    const ch = state.child;
    const doneIds = Object.keys(ch.today).filter(id => ch.today[id]);

    if(ch.today.ontime){
      ch.today.ontime = false;
      const t = getTasks().find(x=>x.id==="ontime");
      if(t && t.xp) applyXp(-t.xp);
    }

    doneIds.forEach(id=>{
      if(id==="ontime") return;
      const t = getTasks().find(x=>x.id===id);
      if(!t) return;
      if(t.xp) applyXp(-t.xp);
      updateWeekly(t, false);
      ch.today[id] = false;
    });

    ch.today = {};
    save(); render();
  }

  // Rewards availability and picker
  function rewardAvailable(r, curLevel){
    if((r.minLevel||1) > curLevel) return { ok:false, reason:`Requires level ${r.minLevel}` };
    const lock = state.rewardLocks[r.id] || {};
    if(lock.untilWeekStart && lock.untilWeekStart === state.weekStart) return { ok:false, reason:`Available next week` };
    if(lock.untilLevel && curLevel < lock.untilLevel) return { ok:false, reason:`Available at level ${lock.untilLevel}` };
    return { ok:true };
  }

  function chooseReward(r){
    const ch = state.child;
    const avail = rewardAvailable(r, ch.level);
    if(!avail.ok){ alert(`Locked: ${avail.reason}`); return; }
    if(ch.unclaimedLevels <= 0){ alert("No unclaimed level-ups right now."); return; }
    state.rewardLocks[r.id] = state.rewardLocks[r.id] || {};
    if(r.weeklyLockout){ state.rewardLocks[r.id].untilWeekStart = state.weekStart; }
    if((r.levelCooldown|0) > 0){ state.rewardLocks[r.id].untilLevel = ch.level + (r.levelCooldown|0); }
    state.rewardsLog.push({ rewardId:r.id, label:r.label, t: Date.now(), level: ch.level });
    ch.unclaimedLevels = Math.max(0, ch.unclaimedLevels - 1);
    save(); render();
    closeRewardPicker();
    alert(`Reward chosen: ${r.label}`);
  }

  function openRewardPicker(){
    const dlg = document.getElementById("rewardPicker");
    const info = document.getElementById("rp-info");
    const grid = document.getElementById("rp-grid");
    const ch = state.child;
    grid.innerHTML = "";

    const rewardList = getRewards().slice();
    let availableCount = 0;

    rewardList.forEach(r=>{
      const check = rewardAvailable(r, ch.level);
      const card = document.createElement("div");
      card.className = "reward-card" + (check.ok ? "" : " locked");
      card.innerHTML = `
        <div>
          <div class="label" style="font-weight:700">${r.label}</div>
          <div class="meta">
            Requires L${r.minLevel||1}${r.weeklyLockout?" · Weekly":""}${(r.levelCooldown|0)>0?` · Cooldown ${r.levelCooldown} lvl`:''}
          </div>
          ${check.ok? "": `<div class="meta">Locked: ${check.reason}</div>`}
        </div>
        <div>
          <button class="chip pick" ${check.ok?"":"disabled"}>Pick</button>
        </div>
      `;
      if(check.ok) availableCount++;
      card.querySelector(".pick").addEventListener("click", ()=>chooseReward(r));
      grid.appendChild(card);
    });

    info.textContent = ch.unclaimedLevels > 0
      ? `You have ${ch.unclaimedLevels} reward${ch.unclaimedLevels>1?'s':''} to claim.`
      : `No unclaimed rewards.`;
    document.getElementById("rp-close").onclick = closeRewardPicker;
    dlg.showModal();
    document.body.classList.add("modal-open");

    if(ch.unclaimedLevels>0 && availableCount===0){
      alert("No rewards are currently eligible. You can claim later when one becomes available.");
    }
  }
  function closeRewardPicker(){ document.getElementById("rewardPicker").close(); document.body.classList.remove("modal-open"); }

  function updateCrestAndProgress(){
    const ch = state.child;
    const step = getLevelStep();
    const pct = step>0 ? ((ch.xp % step) / step) : 0;
    const circumference = 2*Math.PI*18; // r=18
    crestRing.setAttribute("stroke-dasharray", String(circumference.toFixed(3)));
    crestRing.setAttribute("stroke-dashoffset", String((circumference*(1-pct)).toFixed(3)));
    crestLevel.textContent = String(ch.level);
    levelSpan.textContent = String(ch.level);
    xpSpan.textContent = String(ch.xp);
    weekXpSpan.textContent = String(ch.weekXp || 0);
    levelProgress.style.width = `${isFinite(pct)?(pct*100):0}%`;

    const log = state.rewardsLog;
    const last = log[log.length-1];
    recentRewardSpan.textContent = last ? ` · Last reward: ${last.label}` : "";
    chooseRewardBtn.style.display = state.child.unclaimedLevels > 0 ? "inline-flex" : "none";
  }

  function render(){
    applyTheme();
    ensureToday();
    const d = now();
    dateSpan.textContent = `• ${d.toLocaleDateString(undefined, { weekday:'short', month:'short', day:'numeric' })}`;

    const tonight = tasksForTonight();
    taskList.innerHTML = "";
    tonight.forEach(t=>{
      const row = document.createElement("div");
      row.className = "row" + (state.child.today[t.id] ? " done" : "");
      row.dataset.id = t.id;
      row.innerHTML = `
        <div class="left">
          <div class="icon" aria-hidden="true">${t.icon}</div>
          <div>
            <div class="label">${t.label}</div>
            <div class="sub">${t.xp ? `Worth ${t.xp} XP` : `Optional / no XP`}</div>
          </div>
        </div>
        <div class="xp">${t.xp?`+${t.xp} XP`:""}</div>
      `;
      row.addEventListener("click", ()=>toggleTask(t));
      taskList.appendChild(row);
    });

    updateCrestAndProgress();

    const w = state.child.weekly;
    w.swimRequired = requiredSwimPacksThisWeek();
    weeklyGoalsWrap.innerHTML = "";
    getTasks().filter(t=>t.weekly).forEach(t=>{
      const key = t.weekly.key;
      const goal = t.weekly.goalFrom==="swimRequired" ? w.swimRequired : t.weekly.goal;
      const icon = t.icon;
      const label = t.id==="workout" ? "Swimmer Workouts" :
                    t.id==="music" ? "Music sessions" :
                    t.id==="spanish" ? "Spanish lessons" :
                    t.id==="lunch" ? "Lunch packed" :
                    t.id==="swim" ? "Swim bag packed (selected nights)" : t.label;
      const sub = t.weekly && t.weekly.bonusAt ? `Goal ${goal || t.weekly.goal} / week — extra bonus for ${t.weekly.bonusAt}+` :
                  goal ? `Goal ${goal} / week` : "";

      const row = document.createElement("div");
      row.className = "row";
      row.innerHTML = `
        <div class="left">
          <div class="icon">${icon}</div>
          <div>
            <div class="label">${label}</div>
            <div class="sub">${sub}</div>
          </div>
        </div>
        <div><span class="pill">${(w.counts[key]||0)} / ${goal||0}</span></div>
      `;
      weeklyGoalsWrap.appendChild(row);
    });

    rewardsWrap.innerHTML = "";
    const curLevel = state.child.level;
    getRewards().forEach(r=>{
      const avail = rewardAvailable(r, curLevel);
      const span = document.createElement("span");
      span.className = "reward " + (avail.ok ? "available" : "locked");
      span.dataset.minlevel = r.minLevel||1;
      span.title = avail.ok ? "Available" : avail.reason;
      span.textContent = r.label;
      if(avail.ok){
        span.addEventListener("click", ()=>{
          if(state.child.unclaimedLevels>0) chooseReward(r);
        });
      }
      rewardsWrap.appendChild(span);
    });

    document.getElementById("toggle-ontime").textContent = `+${getOnTimeXp()} XP`;
  }

  // Printing helpers
  function printChecklist(){
    const name = "Rafe";
    const css = `
      @page { size: A4; margin: 16mm; }
      body { font-family: Inter, Arial, sans-serif; color: #0b1222; }
      h2 { margin: 0 0 8px 0; }
      .box { border: 2px solid #0f172a; border-radius: 12px; padding: 12px; }
      .row { display: grid; grid-template-columns: 28px 1fr 22px; gap: 8px; align-items: center; padding: 6px 0; border-bottom: 1px dashed #cbd5e1; }
      .row:last-child{ border-bottom: none; }
      .icon { font-size: 18px; text-align: center; }
      .sub { color: #334155; font-size: 12px; }
    `;
    const tonight = tasksForTonight();
    const rows = tonight.map(t => `
      <div class="row"><div class="icon">${t.icon}</div><div>${t.label}</div><div>□</div></div>
    `).join("");
    const extra = `
      <div class="row"><div class="icon">⭐</div><div>On-time: Ready to read by 8:30</div><div>□</div></div>
      <div class="sub">Lights out 9:15 | Swim bag: suit, towel, goggles, cap, flip-flops</div>
    `;
    const html = `
      <html><head><meta charset="utf-8"><title>${name} — Checklist</title><style>${css}</style></head>
      <body>
        <div class="box">
          <h2>${name}</h2>
          ${rows}
          ${extra}
        </div>
      </body></html>
    `;
    openPrint(html);
  }

  function printLedger(){
    const name = "Rafe";
    const css = `
      @page { size: A4; margin: 16mm; }
      body { font-family: Inter, Arial, sans-serif; color: #0b1222; }
      h2 { margin: 0 0 8px 0; }
      table { width: 100%; border-collapse: collapse; }
      th, td { border: 1px solid #94a3b8; padding: 6px; font-size: 12px; }
      th { background: #e2e8f0; }
      .sub { color: #334155; font-size: 12px; }
    `;
    const tonight = tasksForTonight();
    const cols = ["Child","Day", ...tonight.map(t=>t.label), "On-Time","Daily XP"];
    const days = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];
    const head = cols.map(c=>`<th>${c}</th>`).join("");
    const rows = days.map(day=>{
      const boxes = tonight.map(()=>"<td>□</td>").join("");
      return `<tr><td>${name}</td><td>${day}</td>${boxes}<td>□</td><td></td></tr>`;
    }).join("");
    const html = `
      <html><head><meta charset="utf-8"><title>${name} — Weekly XP Ledger</title><style>${css}</style></head>
      <body>
        <h2>Weekly XP Ledger — ${name}</h2>
        <table>
          <tr>${head}</tr>
          ${rows}
        </table>
        <p class="sub">Weekly bonuses reflect your current settings.</p>
      </body></html>
    `;
    openPrint(html);
  }

  function openPrint(html){
    let win=null;
    try{ win = window.open("", "_blank", "noopener,noreferrer"); }catch(e){ win=null; }
    if(win && win.document){
      win.document.open(); win.document.write(html); win.document.close();
      win.onload = ()=>{ win.focus(); win.print(); };
      setTimeout(()=>{ try{ win.focus(); win.print(); }catch(e){} }, 600);
    } else {
      const prev = document.documentElement.innerHTML;
      const restore = ()=>{ document.open(); document.write(prev); document.close(); };
      document.open(); document.write(html); document.close();
      window.onafterprint = restore;
      setTimeout(()=>window.print(), 50);
    }
  }

  // Settings dialog logic
  const dlg = document.getElementById("settingsDlg");
  document.getElementById("cfg-close").addEventListener("click", ()=>{ dlg.close(); document.body.classList.remove("modal-open"); });
  document.getElementById("cfg-export").addEventListener("click", ()=>{
    const blob = new Blob([JSON.stringify(CONFIG,null,2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `${CHILD_ID}-settings.json`;
    a.click();
    setTimeout(()=>URL.revokeObjectURL(a.href), 500);
  });
  document.getElementById("cfg-import").addEventListener("click", ()=>{
    const pin = prompt("Enter Parent PIN:");
    if(pin !== (CONFIG.parentPin||DEFAULTS.parentPin)){ alert(pinWrongMsg()); return; }
    const inp = document.createElement("input");
    inp.type = "file"; inp.accept = "application/json";
    inp.onchange = () => {
      const f = inp.files[0]; if(!f) return;
      f.text().then(txt=>{
        try{
          const json = JSON.parse(txt);
          let imported = deepMerge(DEFAULTS, json);
          migrateTasksDays(imported);
          migrateRewards(imported);
          CONFIG = imported;
          saveCfg();
          populateSettings();
          applyTheme();
          render();
          alert("Settings imported.");
        }catch{ alert("Invalid JSON file."); }
      });
    };
    inp.click();
  });
  document.getElementById("cfg-reset").addEventListener("click", ()=>{
    const pin = prompt("Enter Parent PIN:");
    if(pin !== (CONFIG.parentPin||DEFAULTS.parentPin)){ alert(pinWrongMsg()); return; }
    if(!confirm("Reset settings to defaults?")) return;
    CONFIG = structuredClone(DEFAULTS);
    saveCfg();
    populateSettings();
    applyTheme();
    render();
  });
  document.getElementById("cfg-save").addEventListener("click", ()=>{
    saveSettingsFromForm();
    dlg.close();
    document.body.classList.remove("modal-open");
  });

  document.getElementById("cfg-apply-delta").addEventListener("click", ()=>{
    const val = Number(document.getElementById("cfg-xp-delta").value);
    if(!Number.isFinite(val) || val===0){ alert("Enter a non-zero XP amount (e.g., 25 or -10)."); return; }
    applyXp(val);
    state.adjustments.push({ t: Date.now(), delta: val });
    save(); render();
    alert(`Applied ${val>0?'+':''}${val} XP to total and week.`);
  });
  document.getElementById("cfg-undo-delta").addEventListener("click", ()=>{
    const last = state.adjustments.pop();
    if(!last){ alert("No manual adjustment to undo."); return; }
    applyXp(-last.delta);
    save(); render();
    alert(`Undid last adjustment (${last.delta>0?'+':''}${last.delta} XP).`);
  });
  document.getElementById("cfg-apply-level").addEventListener("click", ()=>{
    const lvl = Math.max(0, Number(document.getElementById("cfg-set-level").value||0));
    if(!Number.isFinite(lvl) || lvl<0){ alert("Enter a valid level (0 or higher)."); return; }
    state.child.level = Math.floor(lvl);
    save(); render();
    alert(`Level set to ${state.child.level}.`);
  });

  function uniqueId(base, usedSet){
    let n=1; while(usedSet.has(`${base}${n}`)) n++; return `${base}${n}`;
  }

  // Migration helpers
  function migrateTasksDays(cfg){
    if(!Array.isArray(cfg.tasks)) return;
    const legacyPack = Array.isArray(cfg.PACK_NIGHTS) ? cfg.PACK_NIGHTS.slice().sort((a,b)=>a-b) : null;
    cfg.tasks.forEach(t=>{
      if(Array.isArray(t.days) && t.days.length){ return; }
      let preset = null;
      if (t.showIf){
        const s = String(t.showIf);
        if (s.includes("SCHOOL_NIGHTS") && s.includes("includes")) preset = "school";
        else if (s.includes("PACK_NIGHTS") && s.includes("includes")) preset = "pack";
        else preset = "always";
      } else {
        preset = "always";
      }
      if(preset==="school") t.days = [1,2,3,4,5];
      else if(preset==="pack"){
        t.days = (legacyPack && legacyPack.length) ? legacyPack : [4,5,7];
      } else {
        t.days = ALL_DAYS.slice();
      }
      delete t.showIf;
    });
    delete cfg.SCHOOL_NIGHTS;
    delete cfg.PACK_NIGHTS;
  }

  function migrateRewards(cfg){
    if(!Array.isArray(cfg.rewards)) cfg.rewards = [];
    const used = new Set();
    cfg.rewards.forEach(r=>{
      if(!r.id){
        const base = (r.label||"reward").toLowerCase().replace(/[^a-z0-9]+/g,'').slice(0,12) || "reward";
        r.id = uniqueId(base, used);
      }
      used.add(r.id);
      r.minLevel = Math.max(1, Number(r.minLevel||1));
      r.weeklyLockout = !!r.weeklyLockout;
      r.levelCooldown = Math.max(0, Number(r.levelCooldown||0));
    });
  }

  // Rewards manager (Parent Mode)
  function renderRewardsManager(){
    const wrap = document.getElementById("rewards-manager");
    wrap.innerHTML = "";
    getRewards().forEach((r, idx)=>{
      const row = document.createElement("div");
      row.className = "reward-row task-card";
      row.dataset.index = idx;
      row.innerHTML = `
        <div class="inline" style="gap:10px; align-items:flex-end; flex-wrap:wrap">
          <div style="min-width:180px">
            <label>Label</label>
            <input type="text" value="${r.label||""}" data-f="label">
          </div>
          <div style="min-width:120px">
            <label>Required level</label>
            <input type="number" min="1" step="1" value="${r.minLevel||1}" data-f="minLevel">
          </div>
          <label class="inline" style="gap:6px">
            <input type="checkbox" data-f="weeklyLockout" ${r.weeklyLockout?'checked':''}>
            Weekly lockout
          </label>
          <div style="min-width:150px">
            <label>Level cooldown</label>
            <input type="number" min="0" step="1" value="${r.levelCooldown||0}" data-f="levelCooldown">
          </div>
          <div class="inline" style="gap:6px">
            <button class="chip" type="button" data-act="up">↑</button>
            <button class="chip" type="button" data-act="down">↓</button>
            <button class="chip" type="button" data-act="dup">Duplicate</button>
            <button class="chip" type="button" data-act="del">Delete</button>
          </div>
        </div>
        <div class="small-note">ID: ${r.id}</div>
      `;
      row.querySelectorAll("[data-f]").forEach(inp=>{
        inp.addEventListener("input", ()=>{
          const rr = CONFIG.rewards[idx];
          if(inp.getAttribute("data-f")==="label") rr.label = inp.value;
          if(inp.getAttribute("data-f")==="minLevel"){
            const v = Number(inp.value); rr.minLevel = isNaN(v)?1:Math.max(1,v);
          }
          if(inp.getAttribute("data-f")==="weeklyLockout"){
            rr.weeklyLockout = row.querySelector('[data-f="weeklyLockout"]').checked;
          }
          if(inp.getAttribute("data-f")==="levelCooldown"){
            const v = Number(inp.value); rr.levelCooldown = isNaN(v)?0:Math.max(0,v);
          }
          saveCfg();
        });
      });
      row.querySelectorAll("[data-act]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const act = btn.getAttribute("data-act");
          if(act==="up" && idx>0){ const t = CONFIG.rewards[idx-1]; CONFIG.rewards[idx-1]=CONFIG.rewards[idx]; CONFIG.rewards[idx]=t; renderRewardsManager(); }
          if(act==="down" && idx<CONFIG.rewards.length-1){ const t = CONFIG.rewards[idx+1]; CONFIG.rewards[idx+1]=CONFIG.rewards[idx]; CONFIG.rewards[idx]=t; renderRewardsManager(); }
          if(act==="dup"){
            const copy = JSON.parse(JSON.stringify(CONFIG.rewards[idx]));
            const used = new Set(CONFIG.rewards.map(x=>x.id));
            copy.id = uniqueId(copy.id.replace(/\d+$/,'') || "reward", used);
            CONFIG.rewards.splice(idx+1,0,copy); renderRewardsManager();
          }
          if(act==="del"){ CONFIG.rewards.splice(idx,1); renderRewardsManager(); }
          saveCfg();
        });
      });
      wrap.appendChild(row);
    });
  }
  document.getElementById("reward-add").addEventListener("click", ()=>{
    const used = new Set(CONFIG.rewards.map(r=>r.id));
    CONFIG.rewards.push({ id: uniqueId("reward", used), label:"New reward", minLevel:1, weeklyLockout:false, levelCooldown:0 });
    saveCfg();
    renderRewardsManager();
  });

  // Tasks manager (unchanged structure)
  function renderTasksManager(){
    const wrap = document.getElementById("tasks-manager");
    wrap.innerHTML = "";
    CONFIG.tasks.forEach((t, idx)=>{
      const isOnTime = t.special === "ontime";
      if(!Array.isArray(t.days) || !t.days.length) t.days = ALL_DAYS.slice();

      const dayChip = (n, lbl) => {
        const on = t.days.includes(n);
        return `<button type="button" class="chip small ${on?"active":""}" data-day="${n}">${lbl}</button>`;
      };

      const card = document.createElement("div");
      card.className = "task-card";
      card.dataset.index = idx;

      card.innerHTML = `
        <div class="task-row">
          <div>
            <label>Icon</label>
            <input type="text" value="${t.icon||""}" data-f="icon">
          </div>
          <div>
            <label>Label</label>
            <input type="text" value="${t.label||""}" data-f="label">
          </div>
          <div>
            <label>XP</label>
            <input type="number" min="0" step="1" value="${t.xp||0}" data-f="xp">
          </div>
          <div>
            <label>Show on days</label>
            <div class="days-wrap" aria-label="Choose days">
              ${dayChip(1,"Mon")}
              ${dayChip(2,"Tue")}
              ${dayChip(3,"Wed")}
              ${dayChip(4,"Thu")}
              ${dayChip(5,"Fri")}
              ${dayChip(6,"Sat")}
              ${dayChip(7,"Sun")}
            </div>
            <div class="small-note">A task appears only on the selected days.</div>
          </div>
        </div>

        <div class="inline" style="margin-top:8px">
          <div style="min-width:160px">
            <label>Task ID ${isOnTime?'<span class="small-note">(locked)</span>':''}</label>
            <input type="text" value="${t.id}" data-f="id" ${isOnTime?'disabled':''}>
          </div>
          <div class="inline" style="gap:12px">
            <label class="inline" style="gap:6px">
              <input type="checkbox" data-f="weeklyOn" ${t.weekly?'checked':''}>
              Weekly
            </label>
            <div class="inline" style="gap:8px">
              <label>Key</label>
              <input type="text" value="${t.weekly?.key||""}" data-f="weeklyKey" style="width:120px">
            </div>
            <div class="inline" style="gap:8px">
              <label>Goal</label>
              <input type="number" min="0" step="1" value="${t.weekly?.goal ?? ''}" data-f="weeklyGoal" style="width:100px">
            </div>
            <div class="inline" style="gap:8px">
              <label>Bonus at</label>
              <input type="number" min="0" step="1" value="${t.weekly?.bonusAt ?? ''}" data-f="weeklyBonusAt" style="width:100px">
            </div>
            <div class="inline" style="gap:8px">
              <label>Bonus XP</label>
              <input type="number" min="0" step="1" value="${t.weekly?.bonusXp ?? ''}" data-f="weeklyBonusXp" style="width:110px">
            </div>
            <label class="inline" style="gap:6px">
              <input type="checkbox" data-f="weeklyGoalFromSwim" ${t.weekly?.goalFrom==="swimRequired"?'checked':''}>
              Goal from swimRequired
            </label>
          </div>
        </div>

        <div class="task-actions">
          <button class="chip" type="button" data-act="up">↑</button>
          <button class="chip" type="button" data-act="down">↓</button>
          <button class="chip" type="button" data-act="dup">Duplicate</button>
          <button class="chip" type="button" data-act="del" ${isOnTime?'disabled':''}>Delete</button>
        </div>
      `;

      card.querySelectorAll("[data-f]").forEach(inp=>{
        inp.addEventListener("input", ()=> applyTaskEdit(idx));
      });

      card.querySelectorAll("[data-day]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const n = Number(btn.getAttribute("data-day"));
          const i = t.days.indexOf(n);
          if(i>=0) t.days.splice(i,1); else t.days.push(n);
          t.days = t.days.filter((x,i,a)=>a.indexOf(x)===i).sort((a,b)=>a-b);
          saveCfg();
          renderTasksManager();
        });
      });

      card.querySelectorAll("[data-act]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const act = btn.getAttribute("data-act");
          if(act==="up" && idx>0){ const tmp = CONFIG.tasks[idx-1]; CONFIG.tasks[idx-1]=CONFIG.tasks[idx]; CONFIG.tasks[idx]=tmp; renderTasksManager(); }
          if(act==="down" && idx<CONFIG.tasks.length-1){ const tmp = CONFIG.tasks[idx+1]; CONFIG.tasks[idx+1]=CONFIG.tasks[idx]; CONFIG.tasks[idx]=tmp; renderTasksManager(); }
          if(act==="dup"){
            const copy = JSON.parse(JSON.stringify(CONFIG.tasks[idx]));
            copy.id = uniqueId(copy.id.replace(/\d+$/,''), new Set(CONFIG.tasks.map(t=>t.id)));
            CONFIG.tasks.splice(idx+1, 0, copy);
            renderTasksManager();
          }
          if(act==="del"){
            if(confirm("Delete this task?")){ CONFIG.tasks.splice(idx,1); renderTasksManager(); }
          }
          saveCfg();
        });
      });

      wrap.appendChild(card);
    });
  }

  function applyTaskEdit(idx){
    const card = document.querySelector(`.task-card[data-index="${idx}"]`);
    if(!card) return;
    const get = sel => card.querySelector(`[data-f="${sel}"]`);
    const t = CONFIG.tasks[idx];

    t.icon = get("icon").value;
    t.label = get("label").value;
    const nxp = Number(get("xp").value);
    t.xp = isNaN(nxp) ? 0 : Math.max(0, nxp);

    if(t.special!=="ontime"){
      const newId = get("id").value.trim() || t.id;
      if(newId !== t.id){
        if (CONFIG.tasks.some((x,i)=>i!==idx && x.id===newId)){
          alert("That ID is already used. Please choose a unique ID.");
          get("id").value = t.id;
        } else {
          t.id = newId;
        }
      }
    }

    const weeklyOn = card.querySelector('[data-f="weeklyOn"]').checked;
    if(weeklyOn){
      t.weekly = t.weekly || { key: t.id };
      t.weekly.key = card.querySelector('[data-f="weeklyKey"]').value.trim() || t.id;
      const g = card.querySelector('[data-f="weeklyGoal"]').value;
      const ba = card.querySelector('[data-f="weeklyBonusAt"]').value;
      const bx = card.querySelector('[data-f="weeklyBonusXp"]').value;
      t.weekly.goal = g==="" ? undefined : Math.max(0, Number(g)||0);
      t.weekly.bonusAt = ba==="" ? undefined : Math.max(0, Number(ba)||0);
      t.weekly.bonusXp = bx==="" ? undefined : Math.max(0, Number(bx)||0);
      t.weekly.goalFrom = card.querySelector('[data-f="weeklyGoalFromSwim"]').checked ? "swimRequired" : undefined;
    } else {
      delete t.weekly;
    }

    saveCfg();
    renderTasksManager();
  }

  function populateSettings(){
    document.getElementById("cfg-levelStep").value = getLevelStep();
    document.getElementById("cfg-onTimeXp").value = getOnTimeXp();
    document.getElementById("cfg-confetti").checked = !!CONFIG.celebrate?.confetti;
    document.getElementById("cfg-sound").checked = !!CONFIG.celebrate?.sound;
    document.getElementById("cfg-newPin").value = "";
    document.getElementById("cfg-pinHint").value = CONFIG.pinHint || "";
    document.getElementById("cfg-xp-delta").value = "";
    document.getElementById("cfg-set-level").value = "";

    const t = CONFIG.theme || DEFAULTS.theme;
    const mode = t.mode || "auto";
    document.querySelectorAll('input[name="cfg-theme-mode"]').forEach(r=>{
      r.checked = (r.value === mode);
    });
    document.getElementById("cfg-day-start").value = t.dayStart || "07:00";
    document.getElementById("cfg-night-start").value = t.nightStart || "19:00";

    renderTasksManager();
    renderRewardsManager();
  }

  function saveSettingsFromForm(){
    CONFIG.LEVEL_STEP = Math.max(1, Number(document.getElementById("cfg-levelStep").value||DEFAULTS.LEVEL_STEP));
    CONFIG.onTimeXp = Math.max(0, Number(document.getElementById("cfg-onTimeXp").value||DEFAULTS.onTimeXp));

    CONFIG.celebrate = CONFIG.celebrate || {};
    CONFIG.celebrate.confetti = document.getElementById("cfg-confetti").checked;
    CONFIG.celebrate.sound = document.getElementById("cfg-sound").checked;

    const newPin = (document.getElementById("cfg-newPin").value || "").trim();
    if(newPin){
      if(!/^\d{4,10}$/.test(newPin)) { alert("PIN should be 4–10 digits."); return; }
      CONFIG.parentPin = newPin;
      alert("Parent PIN updated.");
    }
    CONFIG.pinHint = (document.getElementById("cfg-pinHint").value || "").trim();

    const mode = document.querySelector('input[name="cfg-theme-mode"]:checked')?.value || "auto";
    const dayStart = document.getElementById("cfg-day-start").value || "07:00";
    const nightStart = document.getElementById("cfg-night-start").value || "19:00";
    CONFIG.theme = { mode, dayStart, nightStart };

    saveCfg();
    applyTheme();
    render();
    alert("Settings saved.");
  }

  // Initial render
  render();

  // Open settings
  function openSettings(){
    populateSettings();
    document.getElementById("settingsDlg").showModal();
    document.body.classList.add("modal-open");
  }
})();
</script>
</body>
</html>
